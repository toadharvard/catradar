## Требования 
Условие задачи доступно по [ссылке](https://docs.google.com/document/d/1XVtSK7dWyxdnMc5_6oWdgPVQMg05BTsL3GECMffpDtE/edit?tab=t.0). Необходимо разработать приложение для моделирования и визуализации в реальном времени поведения большого количества котов на прямоугольной карте.
На основе условия были сформированы следующие требования:

 - Приложение должно корректно работать на следующих платформах: Windows 11, Linux Ubuntu 24.04, macOS 14. Под корректностью подразумевается, что приложение не крашится при использовании пользователем всех реализованных фич. При этом приложение представляет гибкие настройки симуляции, которые будут описаны ниже. Большие значения некоторых настроек для слабых машин могут привести к зависаниям. Машины, на которых гарантируются обработка всех допустимых значений всех настроек, описаны под (*)
 - Движение котов
   - Коты должны перемещаться по полю, не имея возможности выйти за его границы
   - Приложение должно само генерировать данные о позициях котов на поле на основе паттернов движения, а не получать их из внешнего источника
   - Пользователь должен иметь возможность выбирать паттерн движения котов. Всего необходимо поддерживать 3 паттерна:
     - Свободное (все коты движутся по прямой и не сталкиваются)
     - Карусельное (коты движутся по кругу, не сталкиваются)
     - Со сталкиванием (коты движутся по прямой, но меняют направление движения при столкновении с другими котами)
   - Пользователь должен иметь возможность регулировать скорость перемещения котов
   - Пользователь может "разогнать котов": при нажатии по полю, коты, находящиеся рядом с курсором, должны резко покинуть эту зону
   - Пересчет позиций котов должно происходить за время, не превышающее `τ` <= 0.5 секунд (*)
 - Симуляция
   - Необходима возможность перезапуска симуляции с новыми параметрами, которые пользователь может менять:
     - Ширина и высота поля, не больше 25000 условных единиц
     - Количество котов, не больше 5*10^6 (\*)
     - Радиусы взаимодействий (R1 для шипения и R0 для драки)
   - Пользователь должен иметь возможность выбрать кота, смена состояний которого будет логироваться
     - Логи должны обновляться тогда и только тогда, когда изменилось состояние у выбранного кота 
   - Пользователь может выбирать одну из трех функций подсчета расстояний между котами:
     - Евклидово
     - Манхэттенское
     - Чебышёва
   - В любой момент времени состояние 95% котов должно быть определено корректно
   - Пересчет состояний котов должен происходить за время, не превышающее `τ` <= 0.5 секунд (*)
 - Графический интерфейс
   - Показывает все необходимые настройки симуляции, панель с логами и поле с котами
   - Пользователь должен иметь возможность увидеть каждого кота
   - Выбранный пользователем логируемый кот должен отличаться внешним видом от всех остальных
   - Внешний вид котов с разными состояниями должен отличаться
   - Внешний вид котов с одинаковыми состояниями должен быть одинаков (исключение - логируемый кот)

(*) Такое ограничение предполагается для машин, сопоставимых по мощности с:
 - Lenovo ThinkBook 14 G5+ IRH, 32 ГБ оперативной памяти, процессор 13th Gen Intel® Core™ i7-13700H × 20
 - MacBook Pro 16", 36 ГБ оперативной памяти, процессор Apple M3 Pro

Для устройств с меньшей производительностью допускается увеличение времени выполнения для большого количества котов 

## Инструменты
### Taichi
Основным фреймворком для нашего приложения был выбран [Taichi](https://www.taichi-lang.org/) (встроенный в python язык программирования для высокопроизводительных численных вычислений). Основными причинами его выбора послужили простота реализаций на нём высокопроизводительных систем и его мультиплатформенность.


### Альтернативы

У каждого участника в нашей команде разные операционные системы, поэтому при выборе фреймворка мы обращали внимание на поддержку MacOS и Linux.
При этом, если разрабатываемый инструмент станет кроссплатформенным, это, несомненно, будет плюсом для пользователей.
В процессе выбора инструментов для разработки мы рассматривали следующие фреймворки, но в итоге отказались от их использования по ряду причин:

-   **OpenGL:**
    *  **Ограниченная поддержка на macOS:** В 2018 году компания Apple объявила OpenGL устаревшим на своих продуктах, рекомендуя вместо него использовать Metal. Это может привести к трудностям в использовании OpenGL и проблемам с производительностью на платформе macOS.
    *   **Низкоуровневый API:** OpenGL предоставляет низкоуровневый API, требующий большого количества ручной работы для отрисовки даже простых сцен, что значительно увеличивает сложность и время разработки.

-   **Vulkan:**
    *   **Более трудоемкое программирование:** Vulkan требует значительных усилий для управления ресурсами, состояниями и синхронизацией, что усложняет разработку. Поэтому вместо Vulkan нередко используют библиотеки написаные поверх него (к примеру Taichi).

-   **Metal (Apple):**
    *   **Ограничение платформы:** Metal является проприетарным API от Apple и работает **только на macOS и iOS**. Это делает его непригодным для нашего проекта, который должен быть кроссплатформенным.

Таким образом, был выбран именно Taichi, плюсы которого описаны в разделе выше.

## Алгоритм

В качестве алгоритма для определения взаимодействующих котов была взята одна из реализаций поиска соседей на основе сеточного разбиения (grid-based neighborhood search). Конкретная реализация алгоритма была взята отсюда https://docs.taichi-lang.org/blog/acclerate-collision-detection-with-taichi

### Альтернатива
При обсуждении деталей проекта также рассматривался алгоритм Форчуна, который обсуждался в рамках лекций по компьютерной графике. Однако от его использования было принято решение отказаться. Основным преимуществом сеточного разбиения перед алгоритмом Форчуна стала относительная простота реализации первого.
После реализации сеточного разбиения и покрытия его тестами мы убедились, что он дает требуемые результаты по точности и производительности.

## Архитектура проекта

Работа с Taichi накладывает некоторые ограничения на разработку. Из-за чего в рамках проекта не встречаются собственные классы и по большей части они заменены файлами. Для корректной работы большинства файлов прежде всего нужно проинициализировать их данные с помощью функции `setup_...()`

![catradar-arch](https://github.com/user-attachments/assets/477128a4-c033-425c-a51a-bc784d69b795)

*Архитектура проекта (не UML)*

### `__main__.py`

Файл, содержащий главный цикл, который отвечает за обновление всех необходимых компонентов.
А так же файл отвечающий за пользовательские настройки.

### `canvas.py`
Файл отвечающий за отображение "холста" с котами.
Публичные функции:
- setup_data_for_scene: инициализация данных
- draw_borders: отрисовка границ области (вынесено в отдельную функцию для возможности отключить для повышения производительности)
- draw_circles: отрисовка котов/точек


### `grid_manager.py`
Файл отвечающий за обновление состояний у котов и сбор логов.

Публичные функции:
- setup_grid_data: инициализация данных
- compute_states: пересчёт состояний с использованием сетки
- update_logs: добавление в лог нового сообщения, если состояние логируемого кота изменилось


### `positions_updater.py`
Файл отвечающий за обновление позиций у котов.

Публичные функции:
- setup_positions_data: инициализация данных
- initialize_positions: инициализация(/сброс) позиций
- update_positions: обновление позиции котов на основе выбранного паттерна движения



### Вспомогательные файлы
#### `common.py`
Содержит общие константы.
- "enum" возможных состояний котов
	- и его отображение в строки
- "enum" метрик расстояния
- "enum" паттернов перемещения котов
- "enum" возможных режимов работ программы
	- обычное
	- запуск для тестов

#### `utils.py`
Файл с общими вспомогательными вещами. В данный момент содержит только функцию `trace()` для отслеживания времени выполнения отдельных частей кода.

## План тестирования
Чтобы убедиться, что реализованное приложение соответствует выдвинутым требованиям, был составлен следующий план тестирования:
### Объекты тестирования
- модуль `grid_manager`
- модуль `positions_updater`
- приложение как единое целое
### Подходы к тестированию
Все автоматические тесты необходимо запускать при процессах непрерывной интеграции на трех целевых платформах последней версии.
Также предполагается, что при ручном тестировании нужно покрыть все целевые платформы, заявленные в требованиях.
То есть каждый тестовый сценарий надо проверять на следующих машинах и системах:
- MacBook Pro 16" M3 Pro, 36 ГБ (1 ОС)
- Lenovo ThinkBook 14 G5+ IRH, процессор 13th Gen Intel® Core™ i7-13700H × 20, 32 ГБ (2 ОС)
  - Одна ОС Windows 11
  - Вторая ОС Linux Ubuntu 24.04

#### Движение котов
  - Протестировать паттерн свободное движение 
    - Написать юнит-тесты на функцию `update_pos_on_velocity` модуля `positions_updater`. Проверить, что позиции котов обновляются правильно и они не выходят за поле 
  - Протестировать вручную ползунок изменения скорости котов в изоляции:
    1. Включить машину и запустить приложение catradar
    2. Передвинуть ползунок в крайнее левое положение (0). Убедиться, что коты перестали двигаться 
    3. Убедиться, что скорость увеличивается, медленно двигая ползунок из крайнего левого положения в крайнее правое 
    4. Убедиться, что скорость уменьшается, двигая ползунок из крайнего правого положения в крайнее левое 
    5. Закрыть приложение и выключить машину 
  - Протестировать вручную карусельный паттерн движения:
    1. Включить машину и запустить приложение catradar
    2. Выбрать карусельный паттерн движения
    3. Наблюдать 30 секунд. Убедиться, что коты движутся по кругу. Убедиться, что со временем коты не отклоняются от траектории. Убедиться, что коты не выходят за поле
    4. Закрыть приложение и выключить машину 
  - Протестировать вручную паттерн движения со столкновениями:
    1. Включить машину и запустить приложение catradar
    2. Выбрать паттерн движения со столкновениями
    3. Наблюдать 30 секунд. Убедиться, что коты отталкиваются при встрече и не проходят сквозь друг друга.  Убедиться, что коты не выходят за поле
    4. Закрыть приложение и выключить машину 
  - Протестировать вручную возможность разгона котов:
    1. Включить машину и запустить приложение catradar
    2. Включить опцию "Allow cursor push"
    3. Несколько раз кликнуть по области с котами. Каждый раз они должны "разбегаться" от курсора
    4. Зажать курсор. При приближении к нему коты должны менять направление и убегать
    5. Выключить опцию "Allow cursor push"
    6. Убедиться, что клик по области больше не влияет на поведение котов
    7. Закрыть приложение и выключить машину
#### Симуляция + графический интерфейс
  - Протестировать корректность определения состояния котов 
    - Написать юнит-тесты для модуля `grid_manager`. При тестировании было показано, что в итоговой системе верно определяются состояния 99% котов (более сильный результат, чем тот, что указан в требованиях). Более подробно про логику тестирования этого модуля можно прочитать [здесь](https://github.com/toadharvard/catradar/blob/tests/README.md).
  - Проверить, что цвет котов в разных состояниях отличается 
    - Во время запущенной симуляции следить за котами на маленькой скорости 
  - Протестировать возможность перезапуска симуляции
     1. Включить машину и запустить приложение catradar
     2. Выставить новые значения для всех опций в меню "Simulation parameters", перезапустить симуляцию
     3. Повторить пункт 2 несколько раз, каждый раз экспериментируя с новыми значениями
     4. Закрыть приложение и выключить машину
  - Протестировать различия между функциями вычисления расстояний
     1. Включить машину и запустить приложение catradar
     2. Выставить значение скорости котов в 0
     3. При необходимости немного увеличить количество котов
     4. Убедиться, что при смене функции вычисления расстояния состояния котов также меняются
     5. Закрыть приложение и выключить машину
  - Протестировать логи
    1. Включить машину и запустить приложение catradar
    2. Убедиться, что на поле есть кот, которые отличается по цвету от остальных - логируемый кот
    3. Уменьшить скорость котов 
    4. Проследить, что при смене цвета логиуемого кота добавляется соответсвующая запись в логи
    5. Закрыть приложение и выключить машину
  - Протестировать видимость котов 
    1. Включить машину и запустить приложение catradar
    2. Поставить наибольший размер карты 
    3. Убедиться, что движение и зум камеры работают и есть возможность увидеть любую часть поля
    4. Закрыть приложение и выключить машину
#### Производительность + интеграционный тест
Проверяются только на машинах, указанных в сноске (*) требований. Приложение показывает FPS в шапке окна.
Соответственно, чтобы удовлетворить требованиями на `τ`, при выполнении сценариев необходимо следить, что FPS >= 2.
 1. Включить машину и запустить приложение catradar
 2. Поставить максимальное допустимое значение количества котов 
 3. Рассмотреть несколько вариантов значений размеров поля (перезапускать симуляцию на каждый с помощью кнопки Reset), не меняя количество котов
 4. Рассмотреть разные паттерны движения и функции вычисления расстояний 
 5. Воспользоваться опцией "Allow cursor push"
 6. Закрыть приложение и выключить машину